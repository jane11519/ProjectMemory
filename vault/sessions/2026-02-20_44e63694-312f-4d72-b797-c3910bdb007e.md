---
session_id: "44e63694-312f-4d72-b797-c3910bdb007e"
project_dir: 'D:\workspace\claude\RepoMemory'
started_at: 1771570607314
last_saved_at: 1771571236838
turn_count: 4
status: active
---

# Session: 44e63694-312f-4d72-b797-c3910bdb007e

## Rolling Summary

**User**: Implement the following plan:

# Session Summarize — 讓 Claude 做 Summarization（零外部 LLM 成本）

## Context

### 問題
`session capture` 已能自動擷取 Claude Code JSONL transcript 並存入 SQLite + Markdown，但 `rollingSummary` 只是前 N 回合的原始文字截取（max 2000 chars），缺乏語意摘要、決策萃取、成果歸納。

### 目標
新增 `session summarize` 功能，產生結構化 summary（overview, decisions, outcomes, openItems, tags），**不呼叫外部 LLM API**，而是讓 Claude（MCP client）直接處理 summarization。

### 核心洞察
ProjectHub 作為 MCP server 運行在 Claude Code 內，Claude 本身就是最強的 LLM。與其呼叫外部 API，不如透過 MCP tools 提供 transcript 資料，讓 Claude 讀取後生成 summary，再透過 MCP tool 寫回 SQLite + vault。

### 觸發機制約束
Stop hook 是 `async: true` notification，stdout 不會回饋 Claude，因此無法在 on-stop 直接觸發 Claude summarization。替代方案：
1. **手動**：使用者呼叫 `/session-summarize` skill
2. **自動提醒**：SKILL.md 指引 Claude 在對話開始時檢查待 summarize session

---

## Architecture Overview

```
Claude Code (MCP Client)
  │
  │  1. projecthub_session_list  →  列出 sessions（含 hasSummary 狀態）
  │  2. projecthub_session_transcript  →  讀取完整 transcript
  │  3. Claude 生成結構化 summary
  │  4. projecthub_session_update_summary  →  寫回 summary
  │
  ▼
ProjectHub MCP Server
  │
  ├── SessionUseCase (application)
  │     ├── listSessions()  ← 新增，支援 status + hasSummary 過濾
  │     ├── getTranscript()  ← 新增，從 JSONL 備份讀取
  │     └── updateSummary()  ← 新增，儲存結構化 summary
  │
  ├── Session entity (domain)  ← 新增 summaryJson 欄位
  ├── SessionSummary value object (domain)  ← 新增
  ├── SessionPort (domain port)  ← 新增 listSessions() 方法
  │
  └── VaultSessionAdapter (infrastructure)  ← 更新 SQL + Markdown 輸出
```

---

## Step 1: Domain — SessionSummary Value Object

**新增** `src/domain/value-objects/SessionSummary.ts`

```typescript
export interface SessionSummary {
  overview: string;       // 2-3 句話總結這次對話完成了什麼
  decisions: string[];    // 架構/設計決策
  outcomes: string[];     // 成果：新增/修改了什麼功能、檔案
  openItems: string[];    // 待辦/未解決問題/下一步
  tags: string[];         // 主題標籤（用於搜尋）
}
```

---

## Step 2: Domain — 更新 Session Entity

**修改** `src/domain/entities/Session.ts`
...

## Decisions

_No decisions recorded._

## Search Footprint

- `Bash`
- `Edit`
- `Glob`
- `Grep`
- `Read`
- `Task`
- `TaskCreate`
- `TaskUpdate`
- `Write`
