---
session_id: "d9e729db-9918-4054-92d7-5b024487fe34"
project_dir: 'D:\workspace\claude\RepoMemory'
started_at: 1771566721534
last_saved_at: 1771566748091
turn_count: 1
status: active
---

# Session: d9e729db-9918-4054-92d7-5b024487fe34

## Rolling Summary

**User**: Implement the following plan:

# Plan: 修復 Session 機制 — 擷取對話 transcript

## Context
Session markdown 全部是空的，因為：
1. 每次 `session save` 都產生新 session ID（`Date.now()`），沒有持久化
2. CLI 永遠傳入空資料（turnCount: 0, rollingSummary: ''）
3. Hook 無法存取對話內容

**解法**：新增 `session capture` 指令，從 Claude Code 的 JSONL transcript 自動擷取對話內容。

**兩階段設計**：
- **Phase 1（Stop hook 觸發）**：複製 JSONL → 解析為可讀 markdown → 存入 DB
- **Phase 2（手動或排程）**：用 LLM 摘要已擷取的 transcript → 更新 session

## JSONL 格式（~/.claude/projects/<encoded-path>/<uuid>.jsonl）

每行一個 JSON，關鍵欄位：
- `type`: `"user"` | `"assistant"` | `"progress"`
- `sessionId`: conversation UUID（= 檔名）
- `slug`: 對話代號（如 `"serene-puzzling-riddle"`）
- `message.content`: 文字/工具呼叫陣列
- `timestamp`: ISO datetime

路徑編碼：`D:\workspace\claude\RepoMemory` → `D--workspace-claude-RepoMemory`（`:` → `-`、`\`/`/` → `-`）

---

## 變更一覽

| # | 檔案 | 動作 |
|---|------|------|
| 1 | `src/infrastructure/session/TranscriptParser.ts` | **新增** — 解析 JSONL 為結構化對話 |
| 2 | `src/cli/commands/session.ts` | **改** — 新增 `capture` 子指令 |
| 3 | `assets/skill/scripts/on-stop.sh` | **改** — 改呼叫 `session capture` |
| 4 | `.claude/skills/projecthub/scripts/on-stop.sh` | **改** — 同上 |
| 5 | `vault/.gitignore` | **改** — 排除 transcripts 目錄 |

---

## Step 1: TranscriptParser

**File**: `src/infrastructure/session/TranscriptParser.ts`（新增）

解析 JSONL transcript 為結構化資料：

```typescript
/** 單一對話回合 */
export interface ConversationTurn {
  role: 'user' | 'assistant';
  text: string;          // 純文字內容（去除 thinking/tool_use）
  timestamp: string;     // ISO datetime
  toolNames?: string[];  // assistant 回合中使用的工具名稱
}

/** 解析後的 transcript 摘要 */
export interface TranscriptSummary {
  sessionId: string;
  slug: string;
  turns: ConversationTurn[];
  turnCount: number;       // user 訊息數
  startedAt: number;       // ms timestamp
  endedAt: number;         // ms timestamp
  toolsUsed: string[];     // 所有使用過的工具（去重）
  filesModified: string[]; // Write/Edit 的檔案路徑（去重）
}

export function parseTranscript(jsonlContent: string): Transc...

## Decisions

_No decisions recorded._

## Search Footprint

- `Bash`
- `Edit`
- `Glob`
- `Read`
- `TaskCreate`
- `TaskUpdate`
- `Write`
