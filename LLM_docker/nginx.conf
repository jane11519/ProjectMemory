events {}

http {

  upstream llm { server llm:8080; }
  upstream embed { server embedding:8080; }
  upstream rerank { server reranker:8080; }

  map_hash_bucket_size 128;

  map $http_authorization $auth_valid {
    default 0;
    "Bearer ${API_KEY}" 1;
  }

  server {
    listen 80;
    default_type application/json;

    location /healthz {
      return 200 "ok";
    }

    location /v1/chat/completions {
      if ($auth_valid = 0) {
        return 401 '{"error":{"message":"Invalid API key","type":"invalid_request_error","code":"invalid_api_key"}}';
      }
      proxy_pass http://llm/v1/chat/completions;
    }

    location /v1/embeddings {
      if ($auth_valid = 0) {
        return 401 '{"error":{"message":"Invalid API key","type":"invalid_request_error","code":"invalid_api_key"}}';
      }
      proxy_pass http://embed/v1/embeddings;
    }

    location /v1/rerank {
      if ($auth_valid = 0) {
        return 401 '{"error":{"message":"Invalid API key","type":"invalid_request_error","code":"invalid_api_key"}}';
      }
      proxy_pass http://rerank/v1/rerank;
    }
  }
}
